"use client";

import { useState, useEffect, useCallback } from "react";
import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { IOSCard, IOSCardHeader, IOSCardTitle, IOSCardDescription, IOSCardContent } from "@/components/ui/ios-card";
import { LiquidCard } from "@/components/ui/liquid-card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import {
  Baby,
  Moon,
  Stethoscope,
  Clock,
  Plus,
  History,
  User,
  LogOut,
  Heart,
  Activity,
  Calendar,
  CheckCircle,
  AlertCircle,
  Milk,
  Edit,
  Save,
  X,
  CalendarPlus,
  Menu,
  Home as HomeI,
  BarChart3,
  CalendarDays,
  ClipboardList,
  SquareCheck,
  Trophy,
  Thermometer,
  Pill,
  Shield,
  TrendingUp,
  Star
} from "lucide-react";
import { auth, googleProvider } from "@/lib/firebase";
import { signInWithPopup, signOut, onAuthStateChanged } from "firebase/auth";
import { collection, addDoc, query, where, getDocs, doc, deleteDoc, updateDoc } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { addToAppleCalendar, createDoctorAppointmentEvent } from "@/lib/calendar";
import { AnimatedHamburger } from "@/components/ui/animated-hamburger";
import { useToast } from "@/hooks/use-toast";
import { useBabyTrackerLocalStorage, defaultFormData } from "@/hooks/use-baby-tracker-local-storage";
import { useClickOutside } from "@/hooks/use-click-outside";
import Link from "next/link";

interface BabyActivity {
  id: string;
  type: 'feeding' | 'sleep' | 'diaper' | 'poop' | 'doctor' | 'temperature' | 'medication' | 'vaccination' | 'milestone' | 'growth' | 'symptoms';
  timestamp: Date;
  details: any;
  userId: string;
}

export default function Home() {
  const [user, setUser] = useState<any>(null);
  const [activities, setActivities] = useState<BabyActivity[]>([]);
  const [selectedActivity, setSelectedActivity] = useState<string>('');
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [editingActivity, setEditingActivity] = useState<BabyActivity | null>(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [expandedCard, setExpandedCard] = useState<string | null>(null);
  const { toast } = useToast();

  // Form states with localStorage persistence
  const { formData, updateFormData, getFormData, clearFormData }: any = useBabyTrackerLocalStorage();

  // Helper functions for updating form data
  const updateFeedingData = (data: Partial<typeof feedingData>) => updateFormData('feeding', data);
  const updateSleepData = (data: Partial<typeof sleepData>) => updateFormData('sleep', data);
  const updateDiaperData = (data: Partial<typeof diaperData>) => updateFormData('diaper', data);
  const updatePoopData = (data: Partial<typeof poopData>) => updateFormData('poop', data);
  const updateDoctorData = (data: Partial<typeof doctorData>) => updateFormData('doctor', data);
  const updateTemperatureData = (data: Partial<typeof temperatureData>) => updateFormData('temperature', data);
  const updateMedicationData = (data: Partial<typeof medicationData>) => updateFormData('medication', data);
  const updateVaccinationData = (data: Partial<typeof vaccinationData>) => updateFormData('vaccination', data);
  const updateMilestoneData = (data: Partial<typeof milestoneData>) => updateFormData('milestone', data);
  const updateGrowthData = (data: Partial<typeof growthData>) => updateFormData('growth', data);
  const updateSymptomsData = (data: Partial<typeof symptomsData>) => updateFormData('symptoms', data);

  // Extract form data for easier access
  const feedingData = getFormData('feeding');
  const sleepData = getFormData('sleep');
  const diaperData = getFormData('diaper');
  const poopData = getFormData('poop');
  const doctorData = getFormData('doctor');
  const temperatureData = getFormData('temperature');
  const medicationData = getFormData('medication');
  const vaccinationData = getFormData('vaccination');
  const milestoneData = getFormData('milestone');
  const growthData = getFormData('growth');
  const symptomsData = getFormData('symptoms');

  // Form errors
  const [errors, setErrors] = useState<Record<string, string>>({});

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        fetchActivities(currentUser.uid);
      }
    });

    return () => unsubscribe();
  }, []);

  const fetchActivities = async (userId: string) => {
    const q = query(collection(db, "users", userId, "activities"), where("userId", "==", userId));
    const querySnapshot = await getDocs(q);
    const activitiesData = querySnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      timestamp: doc.data().timestamp.toDate()
    })) as BabyActivity[];
    setActivities(activitiesData);
  };

  const handleGoogleSignIn = async () => {
    try {
      await signInWithPopup(auth, googleProvider);
      toast({
        title: "Welcome!",
        description: "Successfully signed in to Baby Tracker.",
      });
    } catch (error) {
      console.error("Error signing in with Google: ", error);
      toast({
        title: "Sign In Error",
        description: "Failed to sign in. Please try again.",
        variant: "destructive",
      });
    }
  };

  const handleSignOut = async () => {
    try {
      await signOut(auth);
      setActivities([]);
      toast({
        title: "Goodbye!",
        description: "Successfully signed out of Baby Tracker.",
      });
    } catch (error) {
      console.error("Error signing out: ", error);
      toast({
        title: "Sign Out Error",
        description: "Failed to sign out. Please try again.",
        variant: "destructive",
      });
    }
  };

  const validateForm = (type: string, data: any) => {
    const newErrors: Record<string, string> = {};

    switch (type) {
      case 'feeding':
        if (!data.amount) newErrors.amount = 'Amount is required';
        break;
      case 'sleep':
        if (!data.duration) newErrors.duration = 'Duration is required';
        break;
      case 'diaper':
        if (!data.type) newErrors.type = 'Type is required';
        break;
      case 'poop':
        if (!data.consistency) newErrors.consistency = 'Consistency is required';
        break;
      case 'doctor':
        if (!data.appointmentType) newErrors.appointmentType = 'Appointment type is required';
        if (!data.date) newErrors.date = 'Date is required';
        break;
      case 'temperature':
        if (!data.temperature) newErrors.temperature = 'Temperature is required';
        break;
      case 'medication':
        if (!data.medicationName) newErrors.medicationName = 'Medication name is required';
        if (!data.dosage) newErrors.dosage = 'Dosage is required';
        break;
      case 'vaccination':
        if (!data.vaccineName) newErrors.vaccineName = 'Vaccine name is required';
        break;
      case 'milestone':
        if (!data.milestoneType) newErrors.milestoneType = 'Milestone type is required';
        break;
      case 'growth':
        if (!data.weight && !data.height && !data.headCircumference) {
          newErrors.growth = 'At least one measurement is required';
        }
        break;
      case 'symptoms':
        if (!data.symptomType) newErrors.symptomType = 'Symptom type is required';
        break;
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const addActivity = async (type: string, data: any) => {
    if (!user) return;

    if (!validateForm(type, data)) {
      return;
    }

    try {
      const docRef = await addDoc(collection(db, "users", user.uid, "activities"), {
        type,
        userId: user.uid,
        timestamp: new Date(),
        details: data
      });

      setActivities(prev => [{
        id: docRef.id,
        type: type as any,
        userId: user.uid,
        timestamp: new Date(),
        details: data
      }, ...prev]);

      // Award points for activity
      try {
        const token = await user.getIdToken();
        await fetch('/api/scoring/activity', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ activityType: type })
        });
      } catch (scoringError) {
        console.warn('Failed to award activity points:', scoringError);
      }

      // Add to Apple Calendar if it's a doctor appointment
      if (type === 'doctor') {
        try {
          const calendarEvent = createDoctorAppointmentEvent(data);
          addToAppleCalendar(calendarEvent);
        } catch (calendarError) {
          console.warn("Could not add to Apple Calendar:", calendarError);
        }
      }

      setIsDialogOpen(false);
      setExpandedCard(null);
      resetForms();
      clearFormData(type);

      // Show success toast
      toast({
        title: "Success!",
        description: `${type.charAt(0).toUpperCase() + type.slice(1)} entry added successfully.`,
      });
    } catch (error) {
      console.error("Error adding activity: ", error);
      toast({
        title: "Error",
        description: "Failed to add activity. Please try again.",
        variant: "destructive",
      });
    }
  };

  const updateActivity = async (id: string, type: string, data: any) => {
    if (!user) return;

    if (!validateForm(type, data)) {
      return;
    }

    try {
      await updateDoc(doc(db, "users", user.uid, "activities", id), {
        details: data
      });

      setActivities(prev => prev.map(activity =>
        activity.id === id
          ? { ...activity, details: data }
          : activity
      ));

      setEditingActivity(null);
      setIsDialogOpen(false);
      setExpandedCard(null);
      resetForms();
      clearFormData(type);

      // Show success toast
      toast({
        title: "Success!",
        description: `${type.charAt(0).toUpperCase() + type.slice(1)} entry updated successfully.`,
      });
    } catch (error) {
      console.error("Error updating activity: ", error);
      toast({
        title: "Error",
        description: "Failed to update activity. Please try again.",
        variant: "destructive",
      });
    }
  };

  const deleteActivity = async (id: string) => {
    try {
      const activityToDelete = activities.find(a => a.id === id);
      await deleteDoc(doc(db, "users", user.uid, "activities", id));
      setActivities(prev => prev.filter(activity => activity.id !== id));

      // Show success toast
      if (activityToDelete) {
        toast({
          title: "Success!",
          description: `${activityToDelete.type.charAt(0).toUpperCase() + activityToDelete.type.slice(1)} entry deleted successfully.`,
        });
      }
    } catch (error) {
      console.error("Error deleting activity: ", error);
      toast({
        title: "Error",
        description: "Failed to delete activity. Please try again.",
        variant: "destructive",
      });
    }
  };

  const resetForms = () => {
    const now = new Date();
    const currentDateTime = now.toISOString().slice(0, 16);
    const currentTime = now.toTimeString().slice(0, 5);

    updateFormData('feeding', { amount: '', notes: '', timestamp: currentDateTime });
    updateFormData('sleep', { duration: '', notes: '', startTime: currentTime, endTime: '', timestamp: currentDateTime });
    updateFormData('diaper', { type: '', notes: '', timestamp: currentDateTime });
    updateFormData('poop', { consistency: '', notes: '', timestamp: currentDateTime });
    updateFormData('doctor', {
      appointmentType: '',
      notes: '',
      questions: '',
      date: currentDateTime,
      location: '',
      doctorName: '',
      hospitalName: ''
    });
    updateFormData('temperature', {
      temperature: '',
      unit: 'celsius',
      notes: '',
      timestamp: currentDateTime
    });
    updateFormData('medication', {
      medicationName: '',
      dosage: '',
      frequency: '',
      duration: '',
      notes: '',
      timestamp: currentDateTime
    });
    updateFormData('vaccination', {
      vaccineName: '',
      doseNumber: '',
      administeredBy: '',
      nextDueDate: '',
      notes: '',
      timestamp: currentDateTime
    });
    updateFormData('milestone', {
      milestoneType: '',
      description: '',
      dateAchieved: '',
      notes: '',
      timestamp: currentDateTime
    });
    updateFormData('growth', {
      weight: '',
      height: '',
      headCircumference: '',
      date: currentDateTime,
      notes: '',
      timestamp: currentDateTime
    });
    updateFormData('symptoms', {
      symptomType: '',
      severity: 'mild',
      description: '',
      startDate: '',
      endDate: '',
      notes: '',
      timestamp: currentDateTime
    });
    setErrors({});
  };

  const handleCardClick = (activityType: string) => {
    if (expandedCard === activityType) {
      setExpandedCard(null);
    } else {
      setSelectedActivity(activityType);
      setEditingActivity(null);
      setExpandedCard(activityType);
    }
  };

  const handleCardHeaderClick = (e: React.MouseEvent, activityType: string) => {
    e.preventDefault();
    e.stopPropagation();
    handleCardClick(activityType);
  };

  const handleFormClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
  };

  const closeExpandedCard = () => {
    setExpandedCard(null);
  };

  // Use click outside hook to close expanded card when clicking outside
  const expandedCardRef = useClickOutside(() => {
    if (expandedCard) {
      closeExpandedCard();
    }
  });

  const openEditDialog = (activity: BabyActivity) => {
    setEditingActivity(activity);
    setSelectedActivity(activity.type);
    setExpandedCard(activity.type);

    // Populate form with existing data
    switch (activity.type) {
      case 'feeding':
        updateFeedingData({
          amount: activity.details.amount || '',
          notes: activity.details.notes || '',
          timestamp: activity.timestamp.toISOString().slice(0, 16)
        });
        break;
      case 'sleep':
        updateSleepData({
          duration: activity.details.duration || '',
          notes: activity.details.notes || '',
          startTime: activity.details.startTime || '',
          endTime: activity.details.endTime || '',
          timestamp: activity.timestamp.toISOString().slice(0, 16)
        });
        break;
      case 'diaper':
        updateDiaperData({
          type: activity.details.type || '',
          notes: activity.details.notes || '',
          timestamp: activity.timestamp.toISOString().slice(0, 16)
        });
        break;
      case 'poop':
        updatePoopData({
          consistency: activity.details.consistency || '',
          notes: activity.details.notes || '',
          timestamp: activity.timestamp.toISOString().slice(0, 16)
        });
        break;
      case 'doctor':
        updateDoctorData({
          appointmentType: activity.details.appointmentType || '',
          notes: activity.details.notes || '',
          questions: activity.details.questions || '',
          date: activity.details.date || new Date(activity.timestamp).toISOString().slice(0, 16),
          location: activity.details.location || '',
          doctorName: activity.details.doctorName || '',
          hospitalName: activity.details.hospitalName || ''
        });
        break;
    }

    setIsDialogOpen(true);
  };

  const renderActivityForm = (activityType: string) => {
    switch (activityType) {
      case 'feeding':
        return (
          <div className="space-y-4">
            <div>
              <Label className="pb-1" htmlFor="amount">Amount (oz) *</Label>
              <Input
                id="amount"
                type="number"
                step="0.1"
                value={feedingData.amount}
                onChange={(e) => updateFeedingData({ amount: e.target.value })}
                placeholder="Enter amount in ounces"
                className={errors.amount ? 'border-red-500' : ''}
              />
              {errors.amount && <p className="text-red-500 text-sm mt-1">{errors.amount}</p>}
            </div>
            <div>
              <Label className="pb-1" htmlFor="feeding-time">Time</Label>
              <Input
                id="feeding-time"
                type="datetime-local"
                value={feedingData.timestamp}
                onChange={(e) => updateFeedingData({ timestamp: e.target.value })}
              />
            </div>
            <div>
              <Label className="pb-1" htmlFor="feeding-notes">Notes</Label>
              <Textarea
                id="feeding-notes"
                value={feedingData.notes}
                onChange={(e) => updateFeedingData({ notes: e.target.value })}
                placeholder="Add any notes about the feeding..."
              />
            </div>
            <Button
              onClick={() => editingActivity
                ? updateActivity(editingActivity.id, 'feeding', feedingData)
                : addActivity('feeding', feedingData)
              }
              className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
            >
              <Save className="mr-2 h-4 w-4" />
              {editingActivity ? 'Update' : 'Add'} Feeding Entry
            </Button>
          </div>
        );

      case 'sleep':
        return (
          <div className="space-y-4">
            <div>
              <Label className="pb-1" htmlFor="duration">Duration (hours) *</Label>
              <Input
                id="duration"
                type="number"
                step="0.1"
                value={sleepData.duration}
                onChange={(e) => updateSleepData({ duration: e.target.value })}
                placeholder="Enter sleep duration"
                className={errors.duration ? 'border-red-500' : ''}
              />
              {errors.duration && <p className="text-red-500 text-sm mt-1">{errors.duration}</p>}
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label className="pb-1" htmlFor="start-time">Start Time</Label>
                <Input
                  id="start-time"
                  type="time"
                  value={sleepData.startTime}
                  onChange={(e) => updateSleepData({ startTime: e.target.value })}
                />
              </div>
              <div>
                <Label className="pb-1" htmlFor="end-time">End Time</Label>
                <Input
                  id="end-time"
                  type="time"
                  value={sleepData.endTime}
                  onChange={(e) => updateSleepData({ endTime: e.target.value })}
                />
              </div>
            </div>
            <div>
              <Label className="pb-1" htmlFor="sleep-time">Date</Label>
              <Input
                id="sleep-time"
                type="datetime-local"
                value={sleepData.timestamp}
                onChange={(e) => updateSleepData({ timestamp: e.target.value })}
              />
            </div>
            <div>
              <Label className="pb-1" htmlFor="sleep-notes">Notes</Label>
              <Textarea
                id="sleep-notes"
                value={sleepData.notes}
                onChange={(e) => updateSleepData({ notes: e.target.value })}
                placeholder="Add any notes about the sleep..."
              />
            </div>
            <Button
              onClick={() => editingActivity
                ? updateActivity(editingActivity.id, 'sleep', sleepData)
                : addActivity('sleep', sleepData)
              }
              className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
            >
              <Save className="mr-2 h-4 w-4" />
              {editingActivity ? 'Update' : 'Add'} Sleep Entry
            </Button>
          </div>
        );

      case 'diaper':
        return (
          <div className="space-y-4">
            <div>
              <Label className="pb-1" htmlFor="diaper-type">Type *</Label>
              <Select value={diaperData.type} onValueChange={(value) => updateDiaperData({ type: value })}>
                <SelectTrigger className={errors.type ? 'border-red-500' : ''}>
                  <SelectValue placeholder="Select diaper type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="wet">Wet</SelectItem>
                  <SelectItem value="dirty">Dirty</SelectItem>
                  <SelectItem value="mixed">Mixed</SelectItem>
                </SelectContent>
              </Select>
              {errors.type && <p className="text-red-500 text-sm mt-1">{errors.type}</p>}
            </div>
            <div>
              <Label className="pb-1" htmlFor="diaper-notes">Notes</Label>
              <Textarea
                id="diaper-notes"
                value={diaperData.notes}
                onChange={(e) => updateDiaperData({ notes: e.target.value })}
                placeholder="Add any notes about the diaper change..."
              />
            </div>
            <Button
              onClick={() => editingActivity
                ? updateActivity(editingActivity.id, 'diaper', diaperData)
                : addActivity('diaper', diaperData)
              }
              className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
            >
              <Save className="mr-2 h-4 w-4" />
              {editingActivity ? 'Update' : 'Add'} Diaper Entry
            </Button>
          </div>
        );

      case 'poop':
        return (
          <div className="space-y-4">
            <div>
              <Label className="pb-1" htmlFor="consistency">Consistency *</Label>
              <Select value={poopData.consistency} onValueChange={(value) => updatePoopData({ consistency: value })}>
                <SelectTrigger className={errors.consistency ? 'border-red-500' : ''}>
                  <SelectValue placeholder="Select consistency" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="hard">Hard</SelectItem>
                  <SelectItem value="normal">Normal</SelectItem>
                  <SelectItem value="soft">Soft</SelectItem>
                  <SelectItem value="watery">Watery</SelectItem>
                </SelectContent>
              </Select>
              {errors.consistency && <p className="text-red-500 text-sm mt-1">{errors.consistency}</p>}
            </div>
            <div>
              <Label className="pb-1" htmlFor="poop-notes">Notes</Label>
              <Textarea
                id="poop-notes"
                value={poopData.notes}
                onChange={(e) => updatePoopData({ notes: e.target.value })}
                placeholder="Add any notes about the poop..."
              />
            </div>
            <Button
              onClick={() => editingActivity
                ? updateActivity(editingActivity.id, 'poop', poopData)
                : addActivity('poop', poopData)
              }
              className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
            >
              <Save className="mr-2 h-4 w-4" />
              {editingActivity ? 'Update' : 'Add'} Poop Entry
            </Button>
          </div>
        );

      case 'doctor':
        return (
          <div className="space-y-4">
            <div>
              <Label className="pb-1" htmlFor="appointment-type">Appointment Type *</Label>
              <Select value={doctorData.appointmentType} onValueChange={(value) => updateDoctorData({ appointmentType: value })}>
                <SelectTrigger className={errors.appointmentType ? 'border-red-500' : ''}>
                  <SelectValue placeholder="Select appointment type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="checkup">Regular Checkup</SelectItem>
                  <SelectItem value="vaccination">Vaccination</SelectItem>
                  <SelectItem value="sick">Sick Visit</SelectItem>
                  <SelectItem value="emergency">Emergency</SelectItem>
                </SelectContent>
              </Select>
              {errors.appointmentType && <p className="text-red-500 text-sm mt-1">{errors.appointmentType}</p>}
            </div>
            <div>
              <Label className="pb-1" htmlFor="date">Date *</Label>
              <Input
                id="date"
                type="datetime-local"
                value={doctorData.date}
                onChange={(e) => updateDoctorData({ date: e.target.value })}
                className={errors.date ? 'border-red-500' : ''}
              />
              {errors.date && <p className="text-red-500 text-sm mt-1">{errors.date}</p>}
            </div>
            <div>
              <Label className="pb-1" htmlFor="doctor-notes">Doctor Notes</Label>
              <Textarea
                id="doctor-notes"
                value={doctorData.notes}
                onChange={(e) => updateDoctorData({ notes: e.target.value })}
                placeholder="Add doctor's notes and recommendations...&#10;• Enter each note on a new line&#10;• Use bullet points for better readability"
                rows={4}
              />
              <p className="text-xs text-muted-foreground mt-1">Tip: Enter each item on a new line for list formatting</p>
            </div>
            <div>
              <Label className="pb-1" htmlFor="questions">Questions to Ask</Label>
              <Textarea
                id="questions"
                value={doctorData.questions}
                onChange={(e) => updateDoctorData({ questions: e.target.value })}
                placeholder="List questions for the next visit...&#10;• What about...?&#10;• Should I be concerned about...?&#10;• When should I...?"
                rows={4}
              />
              <p className="text-xs text-muted-foreground mt-1">Tip: Enter each question on a new line for list formatting</p>
            </div>
            <Button
              onClick={() => editingActivity
                ? updateActivity(editingActivity.id, 'doctor', doctorData)
                : addActivity('doctor', doctorData)
              }
              className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
            >
              <Save className="mr-2 h-4 w-4" />
              {editingActivity ? 'Update' : 'Add'} Doctor Entry
            </Button>
          </div>
        );

      default:
        return (
          <div className="text-center py-4 text-muted-foreground">
            <p>Form for {activityType} coming soon...</p>
          </div>
        );
    }
  };

  const getActivityIcon = (type: string) => {
    switch (type) {
      case 'feeding': return <Milk className="h-5 w-5" />;
      case 'sleep': return <Moon className="h-5 w-5" />;
      case 'diaper': return <Activity className="h-5 w-5" />;
      case 'poop': return <AlertCircle className="h-5 w-5" />;
      case 'doctor': return <Stethoscope className="h-5 w-5" />;
      case 'temperature': return <Thermometer className="h-5 w-5" />;
      case 'medication': return <Pill className="h-5 w-5" />;
      case 'vaccination': return <Shield className="h-5 w-5" />;
      case 'milestone': return <Star className="h-5 w-5" />;
      case 'growth': return <TrendingUp className="h-5 w-5" />;
      case 'symptoms': return <Heart className="h-5 w-5" />;
      default: return <Clock className="h-5 w-5" />;
    }
  };

  const getActivityColor = (type: string) => {
    switch (type) {
      case 'feeding': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
      case 'sleep': return 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
      case 'diaper': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
      case 'poop': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
      case 'doctor': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
      case 'temperature': return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';
      case 'medication': return 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200';
      case 'vaccination': return 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200';
      case 'milestone': return 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200';
      case 'growth': return 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200';
      case 'symptoms': return 'bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200';
      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
    }
  };

  const addToCalendar = (activity: BabyActivity) => {
    if (activity.type === 'doctor') {
      try {
        const calendarEvent = createDoctorAppointmentEvent(activity.details);
        addToAppleCalendar(calendarEvent);
        toast({
          title: "Calendar Added!",
          description: "Doctor appointment added to Apple Calendar.",
        });
      } catch (error) {
        console.error("Error adding to calendar:", error);
        toast({
          title: "Calendar Error",
          description: "Failed to add to Apple Calendar. Please try again.",
          variant: "destructive",
        });
      }
    }
  };

  const parseList = (text: string): string[] => {
    if (!text) return [];
    return text.split('\n').filter(item => item.trim() !== '');
  };

  const formatList = (items: string[]): string => {
    return items.join('\n');
  };

  const renderList = (items: string[], title: string) => {
    if (items.length === 0) return null;

    return (
      <div className="text-sm text-muted-foreground">
        <p className="font-medium mb-2">{title}:</p>
        <ul className="space-y-1 ml-4">
          {items.map((item, index) => (
            <li key={index} className="flex items-start">
              <span className="w-1 h-1 bg-muted-foreground rounded-full mt-2 mr-2 flex-shrink-0" />
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </div>
    );
  };

  const formatActivityDetails = (activity: BabyActivity) => {
    switch (activity.type) {
      case 'feeding':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Milk className="h-4 w-4 text-blue-500" />
              <span className="font-medium">{activity.details.amount} oz</span>
            </div>
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'sleep':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Moon className="h-4 w-4 text-purple-500" />
              <span className="font-medium">{activity.details.duration} hours</span>
            </div>
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'diaper':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Activity className="h-4 w-4 text-green-500" />
              <span className="font-medium capitalize">{activity.details.type}</span>
            </div>
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'poop':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <AlertCircle className="h-4 w-4 text-yellow-500" />
              <span className="font-medium capitalize">{activity.details.consistency}</span>
            </div>
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'doctor':
        const doctorNotes = parseList(activity.details.notes || '');
        const doctorQuestions = parseList(activity.details.questions || '');

        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Stethoscope className="h-4 w-4 text-red-500" />
              <span className="font-medium">{activity.details.appointmentType}</span>
            </div>
            {activity.details.date && (
              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                <Calendar className="h-3 w-3" />
                <span>{new Date(activity.details.date).toLocaleString()}</span>
              </div>
            )}
            {renderList(doctorNotes, "Doctor Notes")}
            {renderList(doctorQuestions, "Questions")}
          </div>
        );
      case 'temperature':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Thermometer className="h-4 w-4 text-orange-500" />
              <span className="font-medium">{activity.details.temperature}°{activity.details.unit === 'fahrenheit' ? 'F' : 'C'}</span>
            </div>
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'medication':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Pill className="h-4 w-4 text-indigo-500" />
              <span className="font-medium">{activity.details.medicationName}</span>
            </div>
            {activity.details.dosage && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Dosage:</span> {activity.details.dosage}
              </div>
            )}
            {activity.details.frequency && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Frequency:</span> {activity.details.frequency}
              </div>
            )}
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'vaccination':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Shield className="h-4 w-4 text-cyan-500" />
              <span className="font-medium">{activity.details.vaccineName}</span>
            </div>
            {activity.details.doseNumber && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Dose:</span> {activity.details.doseNumber}
              </div>
            )}
            {activity.details.administeredBy && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Administered by:</span> {activity.details.administeredBy}
              </div>
            )}
            {activity.details.nextDueDate && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Next due:</span> {new Date(activity.details.nextDueDate).toLocaleDateString()}
              </div>
            )}
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'milestone':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Star className="h-4 w-4 text-pink-500" />
              <span className="font-medium">{activity.details.milestoneType}</span>
            </div>
            {activity.details.dateAchieved && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Achieved:</span> {new Date(activity.details.dateAchieved).toLocaleDateString()}
              </div>
            )}
            {activity.details.description && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Description:</p>
                <p>{activity.details.description}</p>
              </div>
            )}
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'growth':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <TrendingUp className="h-4 w-4 text-emerald-500" />
              <span className="font-medium">Growth Measurements</span>
            </div>
            {activity.details.weight && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Weight:</span> {activity.details.weight} kg
              </div>
            )}
            {activity.details.height && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Height:</span> {activity.details.height} cm
              </div>
            )}
            {activity.details.headCircumference && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Head Circumference:</span> {activity.details.headCircumference} cm
              </div>
            )}
            {activity.details.date && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Date:</span> {new Date(activity.details.date).toLocaleDateString()}
              </div>
            )}
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      case 'symptoms':
        return (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <Heart className="h-4 w-4 text-rose-500" />
              <span className="font-medium">{activity.details.symptomType}</span>
              {activity.details.severity && (
                <Badge variant="outline" className="text-xs">
                  {activity.details.severity}
                </Badge>
              )}
            </div>
            {activity.details.description && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Description:</p>
                <p>{activity.details.description}</p>
              </div>
            )}
            {activity.details.startDate && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Started:</span> {new Date(activity.details.startDate).toLocaleDateString()}
              </div>
            )}
            {activity.details.endDate && (
              <div className="text-sm text-muted-foreground">
                <span className="font-medium">Ended:</span> {new Date(activity.details.endDate).toLocaleDateString()}
              </div>
            )}
            {activity.details.notes && (
              <div className="text-sm text-muted-foreground">
                <p className="font-medium mb-1">Notes:</p>
                <p>{activity.details.notes}</p>
              </div>
            )}
          </div>
        );
      default:
        return null;
    }
  };

  const getUserInitials = (displayName: string) => {
    if (!displayName) return 'U';
    const names = displayName.split(' ');
    if (names.length >= 2) {
      return `${names[0].charAt(0).toUpperCase()}${names[names.length - 1].charAt(0).toUpperCase()}`;
    }
    return displayName.charAt(0).toUpperCase();
  };

  if (!user) {
    return (
      <div className="min-h-[100dvh] relative overflow-hidden flex flex-col">
        {/* Gradient background */}
        <div className="absolute inset-0 bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900"></div>
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_20%_50%,rgba(120,119,198,0.1),transparent_50%)]"></div>
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_80%_80%,rgba(120,119,198,0.1),transparent_50%)]"></div>

        <div className="relative z-10 flex flex-col items-center justify-center min-h-[100dvh] p-4 flex-grow">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.8 }}
            className="text-center max-w-md"
          >
            <motion.div
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              transition={{ duration: 0.5, delay: 0.2 }}
              className="mb-8"
            >
              <div className="w-20 h-20 mx-auto bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                <Baby className="h-10 w-10 text-white" />
              </div>
            </motion.div>

            <motion.h1
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.4 }}
              className="text-4xl max-xl:hidden font-bold mb-4 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent"
            >
              Baby Tracker
            </motion.h1>

            <motion.p
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.6 }}
              className="text-lg text-muted-foreground mb-8"
            >
              Track your baby's growth and development with ease
            </motion.p>

            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.5, delay: 0.8 }}
            >
              <Button
                onClick={handleGoogleSignIn}
                size="lg"
                className="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all duration-300"
              >
                <User className="mr-2 h-5 w-5" />
                Sign in with Google
              </Button>
            </motion.div>
          </motion.div>
        </div>

        {/* Footer */}
        <footer className="relative z-10 text-center py-4 text-sm text-muted-foreground">
          Motivated by my first born. Made by abelbejiga.com
        </footer>
      </div>
    );
  }

  return (
    <div className="min-h-[100dvh] relative overflow-hidden flex flex-col">
      {/* Gradient background */}
      <div className="absolute inset-0 bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900"></div>
      <div className="absolute inset-0 bg-[radial-gradient(circle_at_20%_50%,rgba(120,119,198,0.1),transparent_50%)]"></div>
      <div className="absolute inset-0 bg-[radial-gradient(circle_at_80%_80%,rgba(120,119,198,0.1),transparent_50%)]"></div>

      <div className="relative z-10 flex flex-col flex-grow">
        {/* Fixed Header */}
        <motion.header
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="fixed top-0 left-0 right-0 z-50 border-b border-border/40 bg-background/80 backdrop-blur-lg"
        >
          <div className="container mx-auto px-4 py-3 flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <AnimatedHamburger
                isOpen={isSidebarOpen}
                onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                className="lg:hidden"
              />
              <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                <Baby className="h-5 w-5 text-white" />
              </div>
              <h1 className="md:text-2xl text-xl max-lg:!hidden font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                Baby Tracker
              </h1>
            </div>

            <div className="flex items-center space-x-4">
              <div className="hidden sm:flex items-center space-x-2">
                <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                  <span className="text-white text-sm font-semibold">
                    {getUserInitials(user.displayName || '')}
                  </span>
                </div>
              </div>
              <AnimatedHamburger
                isOpen={isSidebarOpen}
                onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                className="hidden lg:flex"
              />
            </div>
          </div>
        </motion.header>

        {/* Sidebar */}
        <motion.div
          initial={{ x: 300 }}
          animate={{ x: isSidebarOpen ? 0 : 300 }}
          transition={{ duration: 0.3, ease: "easeInOut" }}
          className="fixed top-0 right-0 h-full w-72 bg-background/95 backdrop-blur-xl border-l border-border/40 z-40 shadow-2xl"
        >
          <div className="p-6">
            <div className="flex items-center justify-between mb-8">
              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                  <Baby className="h-5 w-5 text-white" />
                </div>
                <h2 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                  Baby Tracker
                </h2>
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={() => setIsSidebarOpen(false)}
                className="lg:hidden"
              >
                <X className="h-5 w-5" />
              </Button>
            </div>

            <div className="space-y-4">
              <div className="flex items-center space-x-3 p-3 rounded-lg bg-muted">
                <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                  <span className="text-white text-sm font-semibold">
                    {getUserInitials(user.displayName || '')}
                  </span>
                </div>
                <div>
                  <p className="font-medium">{user.displayName}</p>
                  <p className="text-sm text-muted-foreground">{user.email}</p>
                </div>
              </div>

              <nav className="space-y-2">
                <Link href="/">
                  <Button
                    variant="ghost"
                    className="w-full justify-start"
                    onClick={() => {
                      setIsSidebarOpen(false);
                    }}
                  >
                    <HomeI className="mr-3 h-5 w-5" />
                    Home
                  </Button>
                </Link>
                <Link href="/activities">
                  <Button
                    variant="ghost"
                    className="w-full justify-start"
                    onClick={() => {
                      setIsSidebarOpen(false);
                    }}
                  >
                    <Activity className="mr-3 h-5 w-5" />
                    Activities
                  </Button>
                </Link>
                <Link href="/summary">
                  <Button
                    variant="ghost"
                    className="w-full justify-start"
                    onClick={() => {
                      setIsSidebarOpen(false);
                    }}
                  >
                    <BarChart3 className="mr-3 h-5 w-5" />
                    Summary
                  </Button>
                </Link>
                <Link href="/appointments">
                  <Button
                    variant="ghost"
                    className="w-full justify-start"
                    onClick={() => {
                      setIsSidebarOpen(false);
                    }}
                  >
                    <CalendarDays className="mr-3 h-5 w-5" />
                    Appointments
                  </Button>
                </Link>
                <Link href="/todo">
                  <Button
                    variant="ghost"
                    className="w-full justify-start"
                    onClick={() => {
                      setIsSidebarOpen(false);
                    }}
                  >
                    <SquareCheck className="mr-3 h-5 w-5" />
                    To-Do
                  </Button>
                </Link>
                <Link href="/leaderboard">
                  <Button
                    variant="ghost"
                    className="w-full justify-start"
                    onClick={() => {
                      setIsSidebarOpen(false);
                    }}
                  >
                    <Trophy className="mr-3 h-5 w-5" />
                    Leaderboard
                  </Button>
                </Link>
              </nav>

              <div className="pt-4 border-t border-border/40">
                <Button
                  variant="outline"
                  className="w-full justify-start hover:bg-destructive hover:text-destructive-foreground"
                  onClick={handleSignOut}
                >
                  <LogOut className="mr-3 h-5 w-5" />
                  Sign Out
                </Button>
              </div>
            </div>
          </div>
        </motion.div>

        {/* Overlay */}
        {isSidebarOpen && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-30"
            onClick={() => setIsSidebarOpen(false)}
          />
        )}

        {/* Main content */}
        <main className="container mx-auto px-4 pt-20 pb-8 flex-grow">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Activity Cards */}
            <div className="lg:col-span-2">
              <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.5, delay: 0.2 }}
              >
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                  {[
                    { type: 'feeding', icon: Milk, title: 'Feeding', description: 'Track feeding time and amount' },
                    { type: 'sleep', icon: Moon, title: 'Sleep', description: 'Monitor sleep patterns' },
                    { type: 'diaper', icon: Activity, title: 'Diaper Change', description: 'Log diaper changes' },
                    { type: 'poop', icon: AlertCircle, title: 'Poop Time', description: 'Track bowel movements' },
                    { type: 'doctor', icon: Stethoscope, title: 'Doctor', description: 'Appointments & notes' },
                    { type: 'temperature', icon: Thermometer, title: 'Temperature', description: 'Monitor body temperature' },
                    { type: 'medication', icon: Pill, title: 'Medication', description: 'Track medications given' },
                    { type: 'vaccination', icon: Shield, title: 'Vaccination', description: 'Record immunizations' },
                    { type: 'milestone', icon: Star, title: 'Milestone', description: 'Log developmental milestones' },
                    { type: 'growth', icon: TrendingUp, title: 'Growth', description: 'Track growth measurements' },
                    { type: 'symptoms', icon: Heart, title: 'Symptoms', description: 'Monitor illness symptoms' },
                  ].map((activity, index) => (
                    <motion.div
                      key={activity.type}
                      initial={{ opacity: 0, scale: 0.9 }}
                      animate={{ opacity: 1, scale: 1 }}
                      transition={{ duration: 0.3, delay: 0.1 * index }}
                      className={`group ${expandedCard === activity.type ? ' absolute z-[2]' : ''}`}
                    >
                      <LiquidCard
                        ref={expandedCard === activity.type ? expandedCardRef : null as any}
                        variant="bubble"
                        colorScheme="blue"
                        intensity="medium"
                        className="h-full">
                        <CardHeader
                          className="pb-3 cursor-pointer"
                          onClick={(e) => handleCardHeaderClick(e, activity.type)}>
                          <div className="flex items-center justify-between space-x-3">
                            <div className="flex items-center space-x-3">
                              <div className="p-2 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg">
                                <activity.icon className="h-5 w-5 text-white" />
                              </div>
                              <div>
                                <CardTitle className="text-lg">{activity.title}</CardTitle>
                                <CardDescription className="text-sm">
                                  {activity.description}
                                </CardDescription>
                              </div>
                            </div>
                            <div className="flex items-center space-x-2">
                              {/* {expandedCard === activity.type && (
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    closeExpandedCard();
                                  }}
                                  className="h-6 w-6 p-0 hover:bg-destructive hover:text-destructive-foreground"
                                >
                                  <X className="h-4 w-4" />
                                </Button>
                              )} */}
                              <motion.div
                                animate={{ rotate: expandedCard === activity.type ? 45 : 0 }}
                                transition={{ duration: 0.3 }}
                              >
                                <Plus className="h-5 w-5 text-muted-foreground" />
                              </motion.div>
                            </div>
                          </div>
                        </CardHeader>

                        {/* Expandable Form Content */}
                        <motion.div
                          initial={{ height: 0, opacity: 0 }}
                          animate={{
                            height: expandedCard === activity.type ? "auto" : 0,
                            opacity: expandedCard === activity.type ? 1 : 0
                          }}
                          transition={{ duration: 0.3, ease: "easeInOut" }}
                          className="overflow-hidden"
                        >
                          <CardContent
                            className="pt-0 border-t border-border/20 mt-4"
                            onClick={handleFormClick}>
                            {renderActivityForm(activity.type)}
                          </CardContent>
                        </motion.div>
                      </LiquidCard>
                    </motion.div>
                  ))}
                </div>
              </motion.div>

              {/* Recent Activities */}
              <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.5, delay: 0.4 }}
              >
                <IOSCard variant="liquid" intensity="medium">
                  <IOSCardHeader>
                    <IOSCardTitle className="flex items-center space-x-2">
                      <History className="h-5 w-5" />
                      <span>Recent Activities</span>
                    </IOSCardTitle>
                  </IOSCardHeader>
                  <IOSCardContent>
                    <div className="space-y-4 max-h-96 overflow-y-auto">
                      {activities.length === 0 ? (
                        <div className="text-center py-8 text-muted-foreground">
                          <Clock className="h-12 w-12 mx-auto mb-4 opacity-50" />
                          <p>No activities yet. Start tracking your baby's activities!</p>
                        </div>
                      ) : (
                        activities.map((activity) => (
                          <motion.div
                            key={activity.id}
                            initial={{ opacity: 0, x: -20 }}
                            animate={{ opacity: 1, x: 0 }}
                            transition={{ duration: 0.3 }}
                            className="flex items-start justify-between p-4 rounded-lg border border-border/40 bg-background/40"
                          >
                            <div className="flex items-start space-x-3 flex-grow">
                              <div className="p-2 rounded-lg bg-background mt-1">
                                {getActivityIcon(activity.type)}
                              </div>
                              <div className="flex-grow">
                                <div className="flex items-center space-x-2 mb-2">
                                  <Badge className={getActivityColor(activity.type)}>
                                    {activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}
                                  </Badge>
                                  <span className="text-sm text-muted-foreground">
                                    {activity.timestamp.toLocaleDateString()} at {activity.timestamp.toLocaleTimeString()}
                                  </span>
                                </div>
                                {formatActivityDetails(activity)}
                              </div>
                            </div>
                            <div className="flex items-center space-x-2 ml-4">
                              {activity.type === 'doctor' && (
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => addToCalendar(activity)}
                                  className="text-green-600 hover:text-green-700 hover:bg-green-50"
                                  title="Add to Apple Calendar"
                                >
                                  <CalendarPlus className="h-4 w-4" />
                                </Button>
                              )}
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => openEditDialog(activity)}
                                className="text-blue-600 hover:text-blue-700 hover:bg-blue-50"
                              >
                                <Edit className="h-4 w-4" />
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => deleteActivity(activity.id)}
                                className="text-destructive hover:text-destructive hover:bg-destructive/10"
                              >
                                <X className="h-4 w-4" />
                              </Button>
                            </div>
                          </motion.div>
                        ))
                      )}
                    </div>
                  </IOSCardContent>
                </IOSCard>
              </motion.div>
            </div>

            {/* Stats Sidebar */}
            <div className="lg:col-span-1">
              <motion.div
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ duration: 0.5, delay: 0.6 }}
                className="space-y-6"
              >
                <IOSCard variant="glass" intensity="medium">
                  <IOSCardHeader>
                    <IOSCardTitle className="flex items-center space-x-2">
                      <Heart className="h-5 w-5" />
                      <span>Today's Summary</span>
                    </IOSCardTitle>
                  </IOSCardHeader>
                  <IOSCardContent>
                    <div className="space-y-4">
                      {[
                        { type: 'feeding', label: 'Feedings', icon: Milk },
                        { type: 'sleep', label: 'Sleep Sessions', icon: Moon },
                        { type: 'diaper', label: 'Diaper Changes', icon: Activity },
                        { type: 'poop', label: 'Poop Times', icon: AlertCircle },
                        { type: 'doctor', label: "Doctor", icon: Stethoscope }
                      ].map((stat) => {
                        const count = activities.filter(
                          activity => activity.type === stat.type &&
                            activity.timestamp.toDateString() === new Date().toDateString()
                        ).length;

                        return (
                          <div key={stat.type} className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <stat.icon className="h-4 w-4 text-muted-foreground" />
                              <span className="text-sm">{stat.label}</span>
                            </div>
                            <Badge variant="secondary">{count}</Badge>
                          </div>
                        );
                      })}
                    </div>
                  </IOSCardContent>
                </IOSCard>

                <IOSCard variant="liquid" intensity="medium">
                  <IOSCardHeader>
                    <IOSCardTitle className="flex items-center space-x-2">
                      <Calendar className="h-5 w-5" />
                      <span>Upcoming</span>
                    </IOSCardTitle>
                  </IOSCardHeader>
                  <IOSCardContent>
                    <div className="space-y-3">
                      {activities.filter(a => a.type === 'doctor').length === 0 ? (
                        <p className="text-sm text-muted-foreground">No upcoming appointments</p>
                      ) : (
                        activities
                          .filter(a => a.type === 'doctor')
                          .map((activity) => (
                            <div key={activity.id} className="p-3 rounded-lg bg-background/40">
                              <div className="flex items-center space-x-2">
                                <CheckCircle className="h-4 w-4 text-green-500" />
                                <span className="text-sm font-medium">
                                  {activity.details.appointmentType}
                                </span>
                              </div>
                              {activity.details.date && (
                                <p className="text-xs text-muted-foreground mt-1">
                                  {new Date(activity.details.date).toLocaleString()}
                                </p>
                              )}
                            </div>
                          ))
                      )}
                    </div>
                  </IOSCardContent>
                </IOSCard>
              </motion.div>
            </div>
          </div>
        </main>

        {/* Footer */}
        <footer className="relative z-10 text-center py-4 text-sm text-muted-foreground border-t border-border/40 bg-background/80 backdrop-blur-sm">
          Motivated by my first born. Made by abelbejiga.com
        </footer>
      </div >

      {/* Activity Dialog - Now using expandable cards instead */}
      <Dialog open={isDialogOpen} onOpenChange={(open) => {
        setIsDialogOpen(open);
        if (!open) {
          setEditingActivity(null);
          resetForms();
        }
      }}>
        <DialogContent className="sm:max-w-md bg-background/95 backdrop-blur-sm border-border/40">
          <DialogHeader>
            <DialogTitle className="flex items-center space-x-2">
              {selectedActivity && getActivityIcon(selectedActivity)}
              <span>
                {editingActivity ? 'Edit' : 'Add'} {selectedActivity?.charAt(0).toUpperCase() + selectedActivity?.slice(1)} Entry
              </span>
            </DialogTitle>
            <DialogDescription>
              {editingActivity ? 'Update' : 'Track'} your baby's {selectedActivity} activity
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4">
            {selectedActivity === 'feeding' && (
              <div className="space-y-4">
                <div>
                  <Label className="pb-1" htmlFor="amount">Amount (oz) *</Label>
                  <Input
                    id="amount"
                    type="number"
                    step="0.1"
                    value={feedingData.amount}
                    onChange={(e) => updateFeedingData({ amount: e.target.value })}
                    placeholder="Enter amount in ounces"
                    className={errors.amount ? 'border-red-500' : ''}
                  />
                  {errors.amount && <p className="text-red-500 text-sm mt-1">{errors.amount}</p>}
                </div>
                <div>
                  <Label className="pb-1" htmlFor="feeding-time">Time</Label>
                  <Input
                    id="feeding-time"
                    type="datetime-local"
                    value={feedingData.timestamp}
                    onChange={(e) => updateFeedingData({ timestamp: e.target.value })}
                  />
                </div>
                <div>
                  <Label className="pb-1" htmlFor="feeding-notes">Notes</Label>
                  <Textarea
                    id="feeding-notes"
                    value={feedingData.notes}
                    onChange={(e) => updateFeedingData({ notes: e.target.value })}
                    placeholder="Add any notes about the feeding..."
                  />
                </div>
                <Button
                  onClick={() => editingActivity 
                    ? updateActivity(editingActivity.id, 'feeding', feedingData)
                    : addActivity('feeding', feedingData)
                  }
                  className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
                >
                  <Save className="mr-2 h-4 w-4" />
                  {editingActivity ? 'Update' : 'Add'} Feeding Entry
                </Button>
              </div>
            )}

            {selectedActivity === 'sleep' && (
              <div className="space-y-4">
                <div>
                  <Label className="pb-1" htmlFor="duration">Duration (hours) *</Label>
                  <Input
                    id="duration"
                    type="number"
                    step="0.1"
                    value={sleepData.duration}
                    onChange={(e) => updateSleepData({ duration: e.target.value })}
                    placeholder="Enter sleep duration"
                    className={errors.duration ? 'border-red-500' : ''}
                  />
                  {errors.duration && <p className="text-red-500 text-sm mt-1">{errors.duration}</p>}
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label className="pb-1" htmlFor="start-time">Start Time</Label>
                    <Input
                      id="start-time"
                      type="time"
                      value={sleepData.startTime}
                      onChange={(e) => updateSleepData({ startTime: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label className="pb-1" htmlFor="end-time">End Time</Label>
                    <Input
                      id="end-time"
                      type="time"
                      value={sleepData.endTime}
                      onChange={(e) => updateSleepData({ endTime: e.target.value })}
                    />
                  </div>
                </div>
                <div>
                  <Label className="pb-1" htmlFor="sleep-time">Date</Label>
                  <Input
                    id="sleep-time"
                    type="datetime-local"
                    value={sleepData.timestamp}
                    onChange={(e) => updateSleepData({ timestamp: e.target.value })}
                  />
                </div>
                <div>
                  <Label className="pb-1" htmlFor="sleep-notes">Notes</Label>
                  <Textarea
                    id="sleep-notes"
                    value={sleepData.notes}
                    onChange={(e) => updateSleepData({ notes: e.target.value })}
                    placeholder="Add any notes about the sleep..."
                  />
                </div>
                <Button
                  onClick={() => editingActivity 
                    ? updateActivity(editingActivity.id, 'sleep', sleepData)
                    : addActivity('sleep', sleepData)
                  }
                  className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
                >
                  <Save className="mr-2 h-4 w-4" />
                  {editingActivity ? 'Update' : 'Add'} Sleep Entry
                </Button>
              </div>
            )}

            {selectedActivity === 'diaper' && (
              <div className="space-y-4">
                <div>
                  <Label className="pb-1" htmlFor="diaper-type">Type *</Label>
                  <Select value={diaperData.type} onValueChange={(value) => updateDiaperData({ type: value })}>
                    <SelectTrigger className={errors.type ? 'border-red-500' : ''}>
                      <SelectValue placeholder="Select diaper type" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="wet">Wet</SelectItem>
                      <SelectItem value="dirty">Dirty</SelectItem>
                      <SelectItem value="mixed">Mixed</SelectItem>
                    </SelectContent>
                  </Select>
                  {errors.type && <p className="text-red-500 text-sm mt-1">{errors.type}</p>}
                </div>
                <div>
                  <Label className="pb-1" htmlFor="diaper-notes">Notes</Label>
                  <Textarea
                    id="diaper-notes"
                    value={diaperData.notes}
                    onChange={(e) => updateDiaperData({ notes: e.target.value })}
                    placeholder="Add any notes about the diaper change..."
                  />
                </div>
                <Button
                  onClick={() => editingActivity 
                    ? updateActivity(editingActivity.id, 'diaper', diaperData)
                    : addActivity('diaper', diaperData)
                  }
                  className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
                >
                  <Save className="mr-2 h-4 w-4" />
                  {editingActivity ? 'Update' : 'Add'} Diaper Entry
                </Button>
              </div>
            )}

            {selectedActivity === 'poop' && (
              <div className="space-y-4">
                <div>
                  <Label className="pb-1" htmlFor="consistency">Consistency *</Label>
                  <Select value={poopData.consistency} onValueChange={(value) => updatePoopData({ consistency: value })}>
                    <SelectTrigger className={errors.consistency ? 'border-red-500' : ''}>
                      <SelectValue placeholder="Select consistency" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="hard">Hard</SelectItem>
                      <SelectItem value="normal">Normal</SelectItem>
                      <SelectItem value="soft">Soft</SelectItem>
                      <SelectItem value="watery">Watery</SelectItem>
                    </SelectContent>
                  </Select>
                  {errors.consistency && <p className="text-red-500 text-sm mt-1">{errors.consistency}</p>}
                </div>
                <div>
                  <Label className="pb-1" htmlFor="poop-notes">Notes</Label>
                  <Textarea
                    id="poop-notes"
                    value={poopData.notes}
                    onChange={(e) => updatePoopData({ notes: e.target.value })}
                    placeholder="Add any notes about the poop..."
                  />
                </div>
                <Button
                  onClick={() => editingActivity 
                    ? updateActivity(editingActivity.id, 'poop', poopData)
                    : addActivity('poop', poopData)
                  }
                  className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
                >
                  <Save className="mr-2 h-4 w-4" />
                  {editingActivity ? 'Update' : 'Add'} Poop Entry
                </Button>
              </div>
            )}

            {selectedActivity === 'doctor' && (
              <div className="space-y-4">
                <div>
                  <Label className="pb-1" htmlFor="appointment-type">Appointment Type *</Label>
                  <Select value={doctorData.appointmentType} onValueChange={(value) => updateDoctorData({ appointmentType: value })}>
                    <SelectTrigger className={errors.appointmentType ? 'border-red-500' : ''}>
                      <SelectValue placeholder="Select appointment type" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="checkup">Regular Checkup</SelectItem>
                      <SelectItem value="vaccination">Vaccination</SelectItem>
                      <SelectItem value="sick">Sick Visit</SelectItem>
                      <SelectItem value="emergency">Emergency</SelectItem>
                    </SelectContent>
                  </Select>
                  {errors.appointmentType && <p className="text-red-500 text-sm mt-1">{errors.appointmentType}</p>}
                </div>
                <div>
                  <Label className="pb-1" htmlFor="date">Date *</Label>
                  <Input
                    id="date"
                    type="datetime-local"
                    value={doctorData.date}
                    onChange={(e) => updateDoctorData({ date: e.target.value })}
                    className={errors.date ? 'border-red-500' : ''}
                  />
                  {errors.date && <p className="text-red-500 text-sm mt-1">{errors.date}</p>}
                </div>
                <div>
                  <Label className="pb-1" htmlFor="doctor-notes">Doctor Notes</Label>
                  <Textarea
                    id="doctor-notes"
                    value={doctorData.notes}
                    onChange={(e) => updateDoctorData({ notes: e.target.value })}
                    placeholder="Add doctor's notes and recommendations..."
                  />
                </div>
                <div>
                  <Label className="pb-1" htmlFor="questions">Questions to Ask</Label>
                  <Textarea
                    id="questions"
                    value={doctorData.questions}
                    onChange={(e) => updateDoctorData({ questions: e.target.value })}
                    placeholder="List questions for the next visit..."
                  />
                </div>
                <Button
                  onClick={() => editingActivity 
                    ? updateActivity(editingActivity.id, 'doctor', doctorData)
                    : addActivity('doctor', doctorData)
                  }
                  className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
                >
                  <Save className="mr-2 h-4 w-4" />
                  {editingActivity ? 'Update' : 'Add'} Doctor Entry
                </Button>
              </div>
            )}
          </div>
        </DialogContent>
      </Dialog>
    </div >
  );
}